name: Release Template Zip

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      bump:
        description: "SemVer segment to bump"
        required: false
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version
        id: version
        env:
          BUMP_TYPE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.bump || 'patch' }}
        run: |
          set -euo pipefail
          git fetch --tags --force

          latest_tag=$(git tag -l 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi

          version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$version"

          case "${BUMP_TYPE}" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            *)
              patch=$((patch + 1))
              ;;
          esac

          new_tag="v${major}.${minor}.${patch}"
          while git rev-parse "$new_tag" >/dev/null 2>&1; do
            patch=$((patch + 1))
            new_tag="v${major}.${minor}.${patch}"
          done

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$new_tag"
          git push origin "$new_tag"

          echo "tag=$new_tag" >> "$GITHUB_OUTPUT"

      - name: Create scaffold zip
        run: |
          cd template
          zip -r ../scaffold-template.zip . -x "**/.DS_Store"
          cd ..

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: scaffold-template
          path: scaffold-template.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: scaffold-template.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
